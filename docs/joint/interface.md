# 第四部分：软硬件接口设计

## 软件接收以太网帧

联合实验进展到此时，实验者应当已经基本完成 CPU 的设计与实现，CPU 应当可以运行代码并往串口打印一些内容了。本节中，实验者需要设计一套软硬件接口，使得运行在 CPU 上的软件能够接收转发引擎传递的需要软件处理的以太网帧。

软硬件接口常见的设计方案有如下几种：

1. 普通MMIO（Memory-Mapped I/O）：类似《计算机组成原理》实验中的串口，通过统一的内存地址访问硬件接口，执行一次寄存器读操作就读取以太网帧的一个字（若干字节）。同时，硬件接口提供状态和长度等寄存器。
2. DMA（Direct Memory Access）：软件在内存中提供一块缓冲区，然后通过MMIO的方式将缓冲区地址和容量写入硬件接口提供的寄存器，硬件此时开始自动接收以太网帧，并将收到的内容写入上述缓冲区。当一个以太网帧接收完成后，硬件在状态寄存器中提供一个标志位或向 CPU 发送一个中断来通知这一事件，然后 CPU 轮询这一标志位或处理相应的中断。同时，硬件接口还可以提供一些寄存器，用于保存上次接收的以太网帧的长度。
3. 共享内存：CPU 上的软件和硬件共享一块缓冲区，然后同时访问某种数据结构（如循环队列）。

转发引擎部分需要按照 IP 分组头部的目标 IP 地址决定是否将此 IP 分组传递给 CPU 上的软件进行处理。需要软件处理的 IP 分组主要包括 RIP 报文（本实验需要实验者使用软件实现 RIP 协议，并设计软硬件接口）。

软件部分需要不断地接收以太网帧并进行处理，还可以通过串口输出帧的信息。实现软件部分的过程中，实验者需要把 C 代码编译为可以直接在实验者的 CPU 上运行的机器码，这需要借助链接器脚本以及若干编译选项来实现。

本节实验的过程中，实验者可能会发现 CPU 实现存在若干问题，或者不支持某些新指令。前者一般可以通过仔细阅读代码找到并修复，而后者一般可以通过修改编译选项解决。

!!! question

    1. 如何从 C 源代码生成可以直接在实验者的 CPU 上运行的机器码？
    2. 链接器脚本起到什么作用？为什么需要链接器脚本？

## 路由器的维护和转发表的更新

在这里，我们区分了路由表和转发表：路由表在软件，转发表在硬件，后者是前者的子集，针对硬件查询而优化。你需要实现一种方法，使得软件可以写（读可选）硬件的转发表，当软件的路由表在更新的时候（比如 RIP 协议的处理过程中），通过这种方法下发到硬件的转发表中。如果实现了读取，就可以通过读出来的数据判断是否正确写入了。如果转发表是基于 RAM 的存储，可以直接给 CPU 提供读取 RAM 的方法，这样就可以比较简单地让 CPU 控制转发表。

如果想要进行无缝的转发表更新，可以实现两份的转发表然后进行原子性的交换；或者在 FSM 的实现上保证不会出现死状态的问题，就可以在牺牲一次转发正确性的情况下解决这个问题。

路由表相比于转发表，主要多了路由协议相关的字段，如 metric。在写入转发表的时候，硬件并不需要这些信息。

## RIP 协议实现

首先照着路由器 -> CPU 的方法实现 CPU -> 路由器的功能，让软件可以发送任意以太网帧。

然后就可以实现一个基本的 RIP 协议，通过软硬件接口进行 RIP 包的收发和路由表的下发。建议参考软件实验的 README 中相关内容。

另请参见：RFC 2453: RIP Version 2