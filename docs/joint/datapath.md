# 第三部分：转发引擎设计

硬件转发引擎的主要模块包括转发逻辑、转发表（路由表）以及 ARP 缓存。同时，本实验 **建议** ARP 协议的处理也采用硬件实现，原因如后文所述。

## ARP 报文接收

本节中，实验者需要在 Loopback 的基础上，对收到的以太网帧进行解析，判断其 EtherType。如果该帧是一个 ARP 报文，则提取出发送者的 MAC 地址以及 IP 地址，然后更新或插入到 ARP 缓存中。实现完成后，实验者可以通过仿真来进行测试，然后使用 ILA 在实验板上进行观察。

实验者可以在与实验路由器相连的主机上使用 `arping` 命令来不断发送 ARP 请求，以便调试。除 ILA 外，实验者也可以把信号接到 LED 上进行观察。请注意，如果信号变化的频率过快，会导致 LED 闪烁过快，人眼是难以观察的。

ARP 协议的更多细节请参见 [RFC 826: An Ethernet Address Resolution Protocol](https://tools.ietf.org/html/rfc826)。

!!! question "思考"

    1. 以太网帧的 EtherType 在哪个位置？ARP 协议对应的 EtherType 是多少？
    2. 操作系统一般会在什么情况下发送 ARP 报文到路由器？
    3. 如何向操作系统添加一条指向实验路由器的路由表项？
    4. 何时 **更新** ARP 缓存表项？何时 **插入** ARP 缓存表项？

## ARP 回复发送

事实上，本实验中，实验者可以把 ARP 回复实现在硬件中，也可以实现在软件中。本实验建议 ARP 回复采用硬件实现，其优点为方便调试，不需要等到 CPU 及软件实现完毕后再进行调试；但是，如果软件需要访问 ARP 缓存，则需要额外的工作。

如果实验者选择由硬件实现 ARP 回复，则首先需要对 ARP 请求进行判断。若 ARP 请求的目标 IP 地址为当前实验路由器对应接口上的 IP 地址，则构造一个 ARP 回复并发送至相同接口。其中，实验路由器四个接口的四个 IP 地址和四个 MAC 地址可以由实验者自行配置，但需要在能够用于自由分配的地址段中选取。特别地，请实验者注意这四个 IP 地址应当在不同的子网，同时不要将 MAC 地址错误地配置为组播地址。

如果实现正确，实验者就可以通过 `arping` 得到稳定的低延迟的回复了。

!!! question "思考"

    1. 什么样的 ARP 报文不需要回复？
    2. 如何在构造 ARP 回复和 Loopback 逻辑二者之间进行选择？

## 路由查询和转发

路由器接收到 IP 分组后，需要先判断是否应该转发。如果应该转发，路由器需要根据目标 IP 地址查询转发表获得下一跳接口（出接口）以及下一跳的 IP 地址（请注意直连路由的特殊处理）。根据需要，如本实验采用以太网，路由器还需要根据下一跳的 IP 地址查询下一跳的 MAC 地址。这些信息都准备好后，路由器即可向正确的出接口转发这一 IP 分组。发送前还需要对以太网帧以及 IP 分组头部的一些字段进行更新，包括减少 TTL、更新校验和、设置目标 MAC 地址（下一跳 MAC 地址）等。

此外，为了提高转发引擎的性能，实验者需要尽量使得转发表查询和 IP 分组接收并行进行，如采用流水线的设计。

实验者需要在仿真中仔细观察转发表和 ARP 缓存查询的结果，以及以太网帧更新后的内容，并分析各个字段是否正确，主要为出接口编号、目标 MAC 地址、IP 分组头部 TTL 以及校验和等字段。若实验者认为这些字段正确，可以进一步尝试使用硬编码的转发表，搭建一个测试网络，用两台主机互相 ping，同时抓包查看具体情况。此时，ILA 会比较有用，实验者可以利用其查看转发引擎中间每一步的情况。另外，建议实验者使用 Linux 系统进行测试，因为它可以关掉许多不相关的流量，让调试变得更加方便。

!!! question "思考"

    1. 如果在转发表中没有查到下一跳信息，应如何处理？
    2. 如果在 ARP 缓存中没有查到对应的 MAC 地址，应如何处理？
    3. 实验者可能会选择在问题 2 中丢弃没有查到 MAC 地址的 IP 分组，而发送一个 ARP 请求。本实验允许这样实现，但这样可能导致什么问题？
    4. 如果 IP 分组头部的 TTL 减到了 0，应如何处理？
    5. 对于 IP 分组头部校验和更新，若采用增量更新的算法，会出现哪些特殊情况？（提示：RFC 也犯过的错）

另请阅读：

1. [RFC 1071: Computing the Internet Checksum](https://tools.ietf.org/html/rfc1071)
2. [RFC 1141: Incremental Updating of the Internet Checksum](https://tools.ietf.org/html/rfc1141)
3. [**RFC 1624: Computation of the Internet Checksum via Incremental Update**](https://tools.ietf.org/html/rfc1624)

## 转发引擎的功能测试和性能测试

在上一节 ping 测试通过的基础上，实验者还需要进一步测试转发引擎的功能正确性和性能。

功能正确性测试主要包括如下几点：

1. IP 分组头部校验和的各种情况都能正确计算，可以通过减少 ping 的间隔（`ping -f <IP 地址>`）来测试；
2. 较大的 IP 分组也可以正常转发，可以通过 ping 指定分组大小或者用 iperf3 测速来测试。

性能测试主要为，通过 iperf3 进行测速，如果出现速度突然降到零并且后续 ping 测试失败的情况，一般说明转发引擎部分逻辑不够鲁棒。此时，实验者可以通过 ILA 查看转发引擎内部状态，找到出问题的部分；实验者也可以在 testbench 中增加以太网帧发送频率，模拟性能测试，然后寻找问题。

!!! question "思考"

    1. PHY/MAC 提供的 AXI-Stream 的接收端没有 `ready` 信号，意味着发送方需要时刻准备好接收数据。请检查实验框架，了解如何实现缓冲区。
    2. 有时会发生冲突而不得不丢包。请检查实验框架，了解 AXI-Stream 如何完整地丢弃一个以太网帧。

