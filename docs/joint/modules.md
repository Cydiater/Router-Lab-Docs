# 第二阶段：网络子模块设计

## 实现转发表

上面提到过 IP 转发，转发的依据就是查转发表，转发表采用的是最长前缀匹配，匹配的结果是下一跳和 VLAN Tag。在实现转发表的时候，需要考虑以下的问题：

!!! question

    1. 数据结构：线性查表、Trie
    2. 存储位置：LUTRAM、BRAM、SRAM
    3. 接口设计：暴露存储、提供插入/删除/查询接口
    4. 最大容量：最大承受多大规模的表项

在目前这个阶段可能对这些还没有什么概念，所以不要过度追求大容量和高性能，建议先设计一个基础、能用的模块，然后配合一个比较完善的 testbench，它应该能够测试基本功能，可能的话可以用脚本生成一些测试数据，然后在仿真中测试它的正确性。

在测试的时候，可以通过一些方式进行转发表的预置，先写死几条在里面。对于 XDP RAM，可以用它的参数进行配置内存；通用地，可以写一段逻辑，仅从 reset 变为 0 开始执行，功能就是插入几条固定的表项。

!!! question

    1. 为什么要重视 testbench？
    2. ThinRouter 上 BRAM 和 SRAM 资源大概都有多大？
    3. BRAM 和 SRAM 的延迟谁更低？
    4. XDP 都提供了哪几种 RAM？Latency 的配置会有哪些影响？
    5. LUTRAM 和 BRAM 的原理不同点在哪？
    6. 如何表示一条直连路由？

## 实现 ARP 表

ARP 表维护的是一个 IP 地址到 MAC 地址的映射关系，比较简单，需要的容量也比较小，简单实现为线性查表或者哈希都可以，可以加上过期的功能。即使比较简单，也要设计好接口，比如查询和插入，写好 testbench，进行足够的测试。

!!! question

    1. 如何实现过期删除的功能？
    2. IP 地址会有局部性吗？
    3. 如何处理满的情况？
