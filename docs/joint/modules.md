# 第二阶段：子模块设计

硬件转发引擎的主要模块包括转发逻辑、转发表（路由表）以及 ARP 缓存。

## 转发表设计与实现

IP 分组转发的依据是转发表。路由器需要使用 IP 分组头部的目标 IP 地址查询转发表，从而确定下一跳接口（出接口）以及下一跳的 IP 地址。其中，转发表采用最长前缀匹配算法。在实现转发表时，实验者可能需要考虑以下问题：

!!! question "思考"

    1. 数据结构：蛮力查找？T-CAM？Trie？Radix Tree？其他？
    2. 存储位置：LUTRAM？BRAM？SRAM？
    3. 接口设计：暴露存储？提供插入、删除、更新及查询接口？
    4. 最大容量：最大需要存储多少路由表项？

在完成转发引擎的整体搭建前，实验者可以暂不过度追求转发表的大容量和高性能。此处建议实验者先设计一个基础且可以正常工作的简单模块，然后配合一个比较完善的 testbench，用以测试基本功能。实验者还可以用脚本生成一些测试数据，然后在仿真时测试转发表的正确性。

测试时，实验者可以通过一些方式将一些路由表项预置在转发表内。对于 FPGA 片内的 RAM，实验者可以用代码或 IP 核的参数配置内容；一般地，实验者可以写一段逻辑，功能为，在复位后插入几条固定的路由表项。

!!! question "思考"

    1. 为什么要重视 testbench？
    2. ThinRouter 上 BRAM 和 SRAM 资源大致容量如何？
    3. BRAM 和 SRAM 的延迟谁更低？
    4. FPGA 片内都提供了哪几种 RAM？Latency 的配置会有哪些影响？
    5. LUTRAM 与 BRAM 的区别如何？
    6. 如何表示一条直连路由表项？

## ARP 缓存设计与实现

ARP 缓存负责缓存 IP 地址与 MAC 地址的对应关系。与转发表不同，其匹配算法采用精确匹配，因此较为简单。根据实际情况，ARP 缓存所需支持的容量也无需太大。实现 ARP 缓存时，实验者可以采用蛮力查找、CAM 或散列表等数据结构，同时可以加入过期自动删除的功能。与转发表类似，实验者需要为 ARP 缓存设计好接口，写好 testbench，并进行充分测试。

!!! question "思考"

    1. 如何实现过期自动删除的功能？
    2. IP 地址会有局部性吗？
    3. 如何处理 ARP 缓存满的情况？
